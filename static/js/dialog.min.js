var dialog=function(){var a=function(){b.genCategories(),c(),d(),e(),b.likeEvent(),f()},b=function(){var a,b="/ideas/",c={popular:b+"get_the_most_popular_ideas/",last:b+"get_the_most_popular_ideas/",random:b+"get_random_ideas/",get_categories:b+"get_categories/",category:b+"get_ideas_by_category/",search:b+"search/",idea:b+"get_idea_by_id/",like:b+"like_thread/","new":b+"new_idea"},d=function(a){function b(a){return $("<li/>").append($("<a/>").attr({href:"#genFromCategory?0&"+a.id}).html(a.name))}var c=b(a);if("subs"in a){var d=$("<ul/>");$.each(a.subs,function(a,c){d.append(b(c))}),c.append(d)}return c},e=function(){a=$.ajax({url:c.get_categories,type:"POST",dataType:"json"}).done(function(a){window.categories=a,$.each(a,function(b){$("nav ul#categories").append(d(a[b]))})})},f=function(a){$(window).scrollTop(0);var b=$("article").find("div.item");b.length,b.each(function(a,b){$(b).fadeOut("slow",function(){$(this).remove()})}),"undefined"!=typeof a&&a()},g=function(b,c){if("undefined"==typeof c||"thread"===c)return $("<div/>").attr("class","item").append($("<div/>").attr("class","thread").append($("<h1/>").attr("class","title").append($("<a/>").attr({href:"#viewThread?"+b.id}).html(b.title)).append($("<h6/>").attr("class","date").html(b.date)).append($("<h6/>").attr("class","author").html(", \u0430\u0432\u0442\u043e\u0440 "+b.creator))).append($("<div/>").attr("class","description").html(b.description))).append($("<div/>").attr("class","social_container").append($("<div/>").attr("class","views icon").append($("<span/>").attr("class","icon-eye")).append(b.views)).append($("<div/>").attr({"class":"likes icon",id:"like_"+b.id}).append($("<span/>").attr("class","icon-heart like"+(b.is_liked?" liked":"")).append(b.likes))));if("empty"===c)return $("<div/>").attr("class","item").append($("<div/>").attr("class","thread").append($("<div/>").attr("class","description").html("\u041f\u043e \u0434\u0430\u043d\u043d\u043e\u043c\u0443 \u0437\u0430\u043f\u0440\u043e\u0441\u0443 \u043d\u0438\u0447\u0435\u0433\u043e \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d\u043e.")));if("addIdea"===c){var d=$("<select/>");$.when(a).done(function(){$.each(window.categories,function(a,b){return d.append($("<option>").text(b.name).attr("value",b.name)),a+1===window.categories.length?(console.log(d),$("<div/>").attr("class","item").append($("<div/>").attr("class","add_idea").append($("<h1/>").attr("class","title").html("\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0438\u0434\u0435\u044e")).append($("<div/>").attr("class","content").append($("<p/>").html("\u041d\u0430\u0437\u0432\u0430\u043d\u0438\u0435:")).append($("<input/>").attr({type:"text",id:"idea_title",placeholder:"\u041d\u0430\u0437\u0432\u0430\u043d\u0438\u0435"})).append($("<p/>").html("\u041a\u0430\u0442\u0435\u0433\u043e\u0440\u0438\u044f:")).append($("<p/>").html("\u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435:")).append($("<textarea/>").attr({id:"idea_editor",cols:80,rows:20}))).append($("<div/>").attr("class","control_buttons").append($("<input/>").attr({type:"button",value:"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c"}))))):void 0})})}},h=function(a,b){f();var c;$.ajax({url:a,type:"POST",data:b,dataType:"json"}).done(function(a){if(a.length>0)for(var b=0;b<a.length;b++)c=g(a[b]).css("display","none"),$("article").append(c),c.fadeIn("slow");else 0===a.length&&(c=g({},"empty").css("display","none"),$("article").append(c),c.fadeIn("slow"))})},i=function(a){h(c.popular,{page:a})},j=function(a){h(c.last,{page:a})},k=function(a){h(c.random,{page:a})},l=function(a,b){h(c.category,{category:b,page:a})},m=function(a){$.ajax({url:c.idea,type:"POST",data:{id:a},dataType:"json"}).done(function(a){f(),$("article").append(g(a).append($("<div/>").attr("class","comments").append($("<p/>").attr("class","title").html("\u041a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0438 (WIP)"))))})},n=function(){f(),$new=g({},"addIdea").css("display","none"),$("article").append($new),$new.fadeIn("slow"),$("#idea_editor").ckeditor()},o=function(){var a;$("body").on("click",".likes",function(){a=$(this),$.ajax({url:c.like,type:"POST",data:{thread_id:a.attr("id").split("_")[1]}}).done(function(b){var c=a.find(".like");"false"!=b?(c.hasClass("liked")?c.removeClass("liked"):c.addClass("liked"),c.html(b)):alert("\u0412\u044b \u0434\u043e\u043b\u0436\u043d\u044b \u0432\u043e\u0439\u0442\u0438 \u0432 \u0441\u0438\u0441\u0442\u0435\u043c\u0443")})})},p=function(a,b){h(c.search,{search:b,page:a})};return{genPopular:i,genLast:j,genRandom:k,genFromCategory:l,genCategories:e,viewThread:m,addIdea:n,likeEvent:o,search:p}}(),c=function(){$("#login_form").submit(function(a){a.preventDefault(),$.ajax({url:"/auth/login/",type:"POST",data:{email:$("#login_email_input").val(),password:$("#login_password_input").val()},dataType:"json"}).done(function(){window.location.reload()})})},d=function(){$("#register_form").submit(function(a){a.preventDefault(),$.ajax({url:"/auth/register/",type:"POST",data:{username:$("#register_username_input").val(),email:$("#register_email_input").val(),password:$("#register_password_input").val(),about:""}}).done(function(){$("#register_form").append($("<p/>").html("\u0414\u043b\u044f \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043d\u0438\u044f \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438 \u0432\u0430\u043c \u043d\u0435\u043e\u0431\u0445\u043e\u0434\u0438\u043c\u043e \u043f\u0440\u043e\u0439\u0442\u0438 \u043f\u043e \u0441\u0441\u044b\u043b\u043a\u0435, \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u043d\u043e\u0439 \u043d\u0430 \u0432\u0430\u0448 \u043f\u043e\u0447\u0442\u043e\u0432\u044b\u0439 \u0430\u0434\u0440\u0435\u0441."))})})},e=function(){$("#logout_button").click(function(a){a.preventDefault(),$.ajax({url:"/auth/logout/",type:"POST"}).done(function(){window.location.reload()})})},f=function(){$("#search").keypress(function(a){13==a.which&&(location.hash="#search?0&"+$(this).children("input").val())})};return{init:a,genPopular:b.genPopular,genLast:b.genLast,genRandom:b.genRandom,genFromCategory:b.genFromCategory,viewThread:b.viewThread,addIdea:b.addIdea,search:b.search}}();